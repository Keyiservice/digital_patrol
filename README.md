# 数字巡检小程序 - 深度解析文档

## 1. 项目愿景与目标

`数字巡检` 是一款专为现代化生产车间量身打造的微信小程序。它旨在彻底革新传统、低效的纸质巡检和报修流程，通过将业务流程数字化、移动化，构建一个透明、高效、可追溯的线上协作平台。

-   **核心目标**:
    -   **无纸化办公**: 消除纸质记录的填写、传递和归档成本。
    -   **提升效率**: 巡检员和工程师可随时随地通过手机完成任务，数据实时同步。
    -   **强化数据追溯**: 所有操作均有时间戳和责任人记录，为质量分析和管理决策提供坚实、可靠的数据基础。
    -   **优化协作流程**: 打通生产、维修、质量部门间的信息壁垒，加速故障响应和处理速度。

---

## 2. 核心功能与使用逻辑详解

本小程序包含四大核心业务模块，以下将详细拆解其使用逻辑和数据流。

### 2.1. 质量巡检 (Quality Patrol)

此模块用于执行常规的产品或产线质量抽检任务。

#### **用户操作流程**

1.  **进入巡检页**:
    -   用户从首页进入 `质量巡检` 页面 (`qua-patrol`)。
    -   系统自动获取当前用户和日期，并预填表单。

2.  **选择巡检计划**:
    -   用户点击 `项目名称` 选择器。该列表内容并非写死在前端，而是通过调用 `getProjectOptions` 云函数，从 `qua_patrol_records` 集合中动态、去重地获取所有历史项目名称，实现了计划的灵活配置。
    -   选择 `产线`。

3.  **执行检查**:
    -   页面会根据预设的检查项，渲染出任务列表。
    -   **数值录入**: 对于 `type: 'input'` 的项目（如厚度），用户直接在输入框中填写测量值。
    -   **状态选择**: 对于 `type: 'radio'` 的项目，用户点选 `OK` 或 `NG`。
    -   **现场拍照**: 每个检查项旁边都有一个相机图标。点击后，用户可拍照上传，作为检查的视觉证据。

4.  **提交表单**:
    -   用户点击 `提交` 按钮。

#### **数据流转解析**

-   **前端 (`qua-inspection.js`)**:
    1.  `onSubmit` 事件被触发。
    2.  程序**首先**遍历所有待上传的图片。
    3.  调用 `wx.cloud.uploadFile` 接口，将每张图片的临时路径 (`wxfile://...`) 上传至**云存储**。
    4.  云存储返回一个永久、唯一的 `fileID` (`cloud://...`)。
    5.  程序将 `fileID` 替换掉原有的临时路径，保存在检查项数据中。
    6.  **然后**，程序将包含所有检查结果（及 `fileID`）的完整表单数据作为参数。
    7.  调用 `saveQuaPatrolRecord` 云函数，将数据提交到后端。
-   **后端 (`saveQuaPatrolRecord/index.js`)**:
    1.  云函数接收到前端传来的完整数据。
    2.  向数据对象中添加 `createTime` (服务器时间) 等系统字段。
    3.  将该对象存入 `qua_patrol_records` 数据库集合中。

#### **列表查看与筛选**

-   在 `质量巡检列表` (`qua-patrol-list`) 中，用户可以通过项目、产线、检查员和日期范围筛选记录。
-   筛选操作会调用 `getQuaPatrolRecords` 云函数，并在**云端**完成数据的过滤，只将符合条件的结果返回前端，极大地优化了性能。

---

### 2.2. 故障报修管理 (Breakdown Management)

此模块实现了一个从"发现故障"到"解决问题"的闭环工作流，其核心是一个基于状态机的流转机制。

| 状态 (Status) | 含义   | 触发页面                 | 下一状态 |
| :------------ | :----- | :----------------------- | :------- |
| `pending`     | 待维修 | `breakdown-production`   | `repaired`  |
| `repaired`    | 待质检 | `breakdown-repair`       | `completed` |
| `completed`   | 已完成 | `breakdown-quality`      | (最终态) |

#### **工作流详解**

1.  **第一步：生产报修 (状态: `pending`)**
    -   **用户**: 生产线员工。
    -   **操作**: 进入 `故障报修列表`，点击"新增"，进入 `breakdown-production` 页面。填写故障设备、问题描述、上传图片后提交。
    -   **数据流**: 调用 `saveBreakdownRecord` 云函数，在 `breakdown_records` 集合中创建一条新记录，`status` 字段值为 `pending`。

2.  **第二步：设备维修 (状态: `repaired`)**
    -   **用户**: 设备维修工程师。
    -   **操作**: 在列表中找到 `待维修` 状态的记录，点击进入 `breakdown-repair` 页面。此页面会预先载入生产提交的故障信息。工程师填写完维修措施、故障原因等信息后提交。
    -   **数据流**: 调用 `updateBreakdownRecord` 云函数，根据记录 ID 更新数据，将 `status` 修改为 `repaired`。

3.  **第三步：质量验证 (状态: `completed`)**
    -   **用户**: 质量部或生产部负责人。
    -   **操作**: 在列表中找到 `待质检` 状态的记录，点击进入 `breakdown-quality` 页面。负责人对维修结果进行检查，填写验证信息后提交。
    -   **数据流**: 再次调用 `updateBreakdownRecord` 云函数，将 `status` 修改为 `completed`，整个流程结束。

---

### 2.3. TPM 与不合格品管理 (TPM & NP)

这两个模块是相对独立的数据记录与查询功能，使用逻辑与质量巡检类似。

-   **数据录入**: 用户进入对应页面 (`tpm-record`, `np-entry`)，填写表单（包含图片上传），提交后由对应的 `save` 云函数保存至数据库。
-   **列表查看**:
    -   `TPM列表` (`tpm-list`) 支持按 **TPM类型**、**设备ID** 和 **日期** 进行后端筛选。
    -   `NP列表` (`np-list`) 支持按 **项目**、**不合格原因** 和 **日期** 进行后端筛选。

---

## 3. 技术栈与设计模式

-   **前端**: 微信小程序原生框架 (WXML, WXSS, JS, WXS)。
-   **后端**: 微信云开发 (Tencent Cloud Base)。
    -   **云函数**: 使用 Node.js 编写，承载所有后端业务逻辑，实现了前后端分离。
    -   **云数据库**: 基于 MongoDB 的 NoSQL 文档数据库，适合存储结构灵活的业务数据。
    -   **云存储**: 负责存储所有用户上传的图片文件，并通过 `fileID` 与数据库记录关联。
-   **核心设计模式**:
    -   **后端筛选 (Server-Side Filtering)**: 这是本项目性能优化的关键。列表页的筛选逻辑全部在云函数中完成，避免了将全部数据加载到小程序内存中再进行过滤，显著降低了前端的性能开销和网络传输量。
    -   **状态机 (State Machine)**: 在故障管理模块中，通过 `status` 字段的流转，清晰地定义了业务流程的每个阶段和转换条件，使得业务逻辑健壮且易于维护。

---

## 4. 项目结构

```
digital_patrol/
├── cloudfunctions/       # 存放所有后端云函数的目录
│   ├── get...Records/    # 各个模块的列表查询函数 (实现了后端筛选)
│   ├── save...Record/    # 各个模块的数据保存函数
│   └── update...Record/  # 各个模块的数据更新函数
├── pages/                # 小程序的所有页面
│   ├── qua-patrol/       # 质量巡检（填写表单）
│   ├── qua-patrol-list/  # 质量巡检（列表与筛选）
│   ├── breakdown-management/ # 故障管理模块，内含多个页面
│   │   ├── breakdown-list.js
│   │   ├── breakdown-production.js # 生产报修页
│   │   ├── breakdown-repair.js   # 维修记录页
│   │   └── breakdown-quality.js  # 质量验证页
│   └── ...
├── app.js                # 小程序逻辑入口
├── app.json              # 小程序公共配置 (路由、窗口表现等)
└── project.config.json   # 项目配置文件 (appid, 云函数根目录等)
```

---

## 5. 未来展望

-   [ ] **数据可视化看板**: 在 `summary` 页面增加 ECharts 等图表库，对故障率、巡检合格率等核心 KPI 进行可视化分析。
-   [ ] **权限管理系统**: 引入角色概念（如管理员、巡检员、维修工），不同角色的用户拥有不同的菜单和操作权限。
-   [ ] **消息推送**: 当故障记录状态变更时（如"待维修"->"待质检"），通过小程序订阅消息，主动推送给下一环节的负责人，提升响应速度。